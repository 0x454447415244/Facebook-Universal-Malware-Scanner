<?php

/////////////////////////////////////////////////////////////////////////
//GET A FACEBOOK ACCOUNT FROM https://www.facebook.com/whitehat/accounts/
$email = "";
$password = "";
/////////////////////////////////////////////////////////////////////////

$UA = "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.11) Gecko/20071127 Firefox/2.0.0.11";
$LOGIN_URL = "https://m.facebook.com/login.php";
$DUMMY_URL = "http://m.facebook.com/messages/";
$UPLOAD_URL = "https://upload.facebook.com/ajax/mercury/upload.php?__a=1&fb_dtsg=";

if(!isset($_FILES["upload_file"])) die("Nop");

if ($_FILES["upload_file"]["error"] == UPLOAD_ERR_OK) {

        $name = $_FILES["upload_file"]["name"];

        $file = $_FILES["upload_file"]["tmp_name"];

        $data = "email=".urlencode($email)."&pass=".urlencode($password)."&login=Login";

        $curl = curl_init();

        curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl, CURLOPT_FOLLOWLOCATION, 1);
        curl_setopt($curl, CURLOPT_USERAGENT, $UA);
        curl_setopt($curl, CURLOPT_COOKIEJAR, "cookies.txt");
        curl_setopt($curl, CURLOPT_COOKIEFILE, "cookies.txt");

        curl_setopt($curl, CURLOPT_POST, 1);
        curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
        
        curl_setopt($curl, CURLOPT_URL, $LOGIN_URL);
        curl_exec ($curl);

        curl_setopt($curl, CURLOPT_POST, 0);
        curl_setopt($curl, CURLOPT_URL, $DUMMY_URL);
        $page = curl_exec($curl);
        preg_match_all('/(?:name="fb_dtsg" value=")(.*?)(?:" autocomplete="off")/', $page, $matches);
        if(!isset($matches[1][0])) { die("Login Error. Make sure you use a valid Facebook account."); }
        $fb_dtsg = $matches[1][0];

        $post1 = array('attach_id' => '', 'images_only' => 'false');
        $post2 = array('upload_1' => $file);
        
        curl_custom_postfields($curl, $post1, $post2);

        $upload_url = $UPLOAD_URL.$fb_dtsg;
        curl_setopt($curl, CURLOPT_URL, $upload_url);
        $page = curl_exec ($curl);
        curl_close ($curl); 
        
        $json = substr($page, 9);
        $json_obj = json_decode($json);

        if(isset($json_obj->error)) {
                if($json_obj->errorSummary == "Virus detected in file upload")
                        echo "<span style='color: red'>Malware detected!</span>";
                else echo "Error!";
        }
        else echo "<span style='color: green'>Clean file.</span>";     
}

//Ref: http://php.net/manual/en/class.curlfile.php
function curl_custom_postfields($ch, array $assoc = array(), array $files = array()) {

    static $disallow = array("\0", "\"", "\r", "\n");

    foreach ($assoc as $k => $v) {
        $k = str_replace($disallow, "_", $k);
        $body[] = implode("\r\n", array("Content-Disposition: form-data; name=\"{$k}\"", "", filter_var($v),));
    }
   
    foreach ($files as $k => $v) {
        switch (true) {
            case false === $v = realpath(filter_var($v)):
            case !is_file($v):
            case !is_readable($v): continue;
        }
        $data = file_get_contents($v);
        $v = call_user_func("end", explode(DIRECTORY_SEPARATOR, $v));
        $k = str_replace($disallow, "_", $k);
        $v = str_replace($disallow, "_", $v);
        $body[] = implode("\r\n", array(
            "Content-Disposition: form-data; name=\"{$k}\"; filename=\"{$v}\"",
            "Content-Type: application/octet-stream",
            "",
            $data,
        ));
    }
    
    do {
        $boundary = "---------------------" . md5(mt_rand() . microtime());
    } while (preg_grep("/{$boundary}/", $body));
   
    array_walk($body, function (&$part) use ($boundary) { $part = "--{$boundary}\r\n{$part}"; });
   
    $body[] = "--{$boundary}--";
    $body[] = "";
   
    return @curl_setopt_array($ch, array(
        CURLOPT_POST       => true,
        CURLOPT_POSTFIELDS => implode("\r\n", $body),
        CURLOPT_HTTPHEADER => array(
            "Expect: 100-continue",
            "Content-Type: multipart/form-data; boundary={$boundary}",
        ),
    ));
}

?>
